---
layout: layout
title: 评论系统的又一次折腾
date: 2020-07-19 18:05:28
tags:
- blog插件
categories:
- blog
---

![评论系统的又一次折腾](http://file.yocoh.cn/images/2020/07/09/v2-dd277cb215d149354298cfe163720588_r.jpg)

> 这次主要添加了这些功能：
>
> - ~~[如果填写的是QQ邮箱，评论的头像将自动拉取QQ头像。](#qq_img)~~**（valine更新了昵称处填写QQ号自动拉取昵称与头像，该方法已废弃）**
> - [现在回复可以收到邮件提醒了。](#reply)



可以点击[这里](https://blog.yocoh.cn/2020/06/19/addcomments/) 看看前情提要，因为用的主题比较小众的原因，许多造轮子大佬都没眷顾到这里，所以一些简单的功能也还是得自己来做。就像网站右下角新加的[aplayer](aplayer.js.org) 一样，不过谁让这个主题这么好看呢！

而且其实现在开源社区也使得技术下沉到大部分问题都可以百度解决。自己搞定一个需求的快乐也是玩博客的一部分。所以废话结束，笔记开始。




<h2 id="qq_img">识别QQ邮箱并拉取QQ头像</h2>

> 这部分功能参考了[cungudafa](https://blog.csdn.net/cungudafa/article/details/104638730/)的文章。

主要用到的是这个接口：

`http://q1.qlogo.cn/g?b=qq&nk=QQ号&s=100`

逻辑是

1. 判断是否为QQ邮箱
2. 将QQ号提取出来
3. 将头像地址改为上面的接口

### 1.快速使用

将`hexo\themes\typography\layout\partial\comments.jade`中引用Valine的位置更改为：

```javascript
script(src="http://git.yocoh.cn/Valine.min.js")
```



### 2.修改过程

之前的Valine是直接通过`jsdelivr`引用的，这次需要对js文件进行修改，所以先将[Valine.min.js](https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js)下载到本地。

然后打开文件，使用<kbd>Ctrl</kbd>+<kbd>F</kbd> 查找：

```
t.get("url")+"</a>";
```

定位到头像位置，在上面的`;`后回车，添加以下内容：

```javascript
var qq_img = E.cdn+(0,s.default)(t.get("mail"))+E.params;
    if (t.get("mail").indexOf("@qq.com") >= 0) {
        var prefix = t.get("mail").replace(/@.*/, "");//前缀
        var pattern = /^\d+$/g;  //正则表达式
        var result = prefix.match(pattern);//match 是匹配的意思
        if (result !== null) {
            qq_img = "http://q1.qlogo.cn/g?b=qq&nk=" + prefix + "&s=100";
        }
    }
```

这段代码表示当邮箱为QQ邮箱时，通过上面的接口将头像存储在`qq_img`中。接下来修改后文的调用为`qq_img`就完成修改啦。

存放头像的元素`class`为`vimg` ，查找`<img class="vimg" src=`，将src中内容修改成`+(qq_img)+`。

![image.png](http://file.yocoh.cn/images/2020/07/19/image.png)file

之后调用`js`文件就可以了，我准备将`js`、`css`文件整理一下全部放在一个域名下，然后通过`cdn`加速，不过是一个大工程呀。

这是效果图：

![评论效果图](http://file.yocoh.cn/images/2020/07/19/image54019aa10af7ea10.png)





<h2 id="reply">收到评论与回复时邮件提醒</h2>

![提醒效果图](http://file.yocoh.cn/images/2020/07/19/imagec9b3a223c642156e.png)

实现流程如下：

1. 阿里云的邮件服务
2. Valine-admin的配置



#### **阿里云邮件推送** 

邮件服务看了很多，绕了一圈又回到了阿里云。毕竟免费实在是太香了。阿里云的配置也比较简单，官网流程引导很细致，直接跟着走应该就没问题了。

[阿里云邮件服务](https://www.aliyun.com/product/directmail?spm=5176.224200.h2v3icoap.439.3f486ed641lXP9)

如果遇到问题也可以在下方给我留言。

<sp>既然都已经安装了hexo，安装了主题，安装了valine走到这里了，应该也不可能会有问题吧。</sp>

#### **Valine-admin配置**

[Valine-admin](https://github.com/zhaojun1998/Valine-Admin)是[zhaojun](https://github.com/zhaojun1998)大神为Valine写的一个拓展应用，专门用于增强邮件通知。

##### **快速配置**

首先最重要的是Valine已经可以正常使用了，然后进入 [Leancloud](https://leancloud.cn/dashboard/applist.html#/apps)对应的应用中。

点击`云引擎 -> 部署`，填写代码库`https://github.com/zhaojun1998/Valine-Admin`

![配置设置](http://file.yocoh.cn/images/2020/07/19/imageeee403bf29c1afb5.png)

![git部署](http://file.yocoh.cn/images/2020/07/19/imagec7205a53e8ef7110.png)

##### **环境变量**

在`云引擎 -> 设置`中设置环境变量：

![环境变量设置](http://file.yocoh.cn/images/2020/07/19/image2e72f44469f05099.png)

**以下是各参数含义：**

* `SITE_NAME` : 网站名称。
* `SITE_URL` : 网站地址, **最后不要加 `/` 。**
* `SMTP_USER` : SMTP 服务用户名，一般为邮箱地址。
* `SMTP_PASS` : SMTP 密码，一般为授权码，而不是邮箱的登陆密码，请自行查询对应邮件服务商的获取方式
* `SMTP_SERVICE` : 邮件服务提供商，支持 `QQ`、`163`、`126`、`Gmail`、`"Yahoo"`、`......`  ，全部支持请参考 : [Nodemailer Supported services](https://nodemailer.com/smtp/well-known/#supported-services)。
* `SENDER_NAME` : 寄件人名称。
* `TO_EMAIL`: 指定站长收信邮箱，默认值为 `SITE_USER`。用于 SMTP 发件人与站长收件人不一致的情况下使用。

**因为我使用的是阿里云，所以设置自定义邮件服务器：**

- `SMTP_HOST` : 邮件服务提供商 SMTP 地址，如 阿里云 : `smtpdm.aliyun.com`，*此项需要自行查询或询问其服务商*。
- `SMTP_PORT` : 邮件服务提供商 SMTP 端口, *此项需要自行查询或询问其服务商*。阿里云默认为`25`,`80`
- `SMTP_SECURE` : 是否启用加密, 默认为 `true`，一般不需要设置，如有特殊请自行配置。 *此项需要自行查询或询问其服务商*。

> 注: 配置自定义邮件服务器的话，请不要同时配置 SMTP_SERVICE。当 SMTP_SERVICE 未配置时才会启用自定义邮件服务

**主题：**

分别为默认主题和 `rainbow` 彩虹主题，我直接选用`rainbow`了。

-  `TEMPLATE_NAME`:`rainbow`/`default`

**还能绑定管理域名：**

如果是国内版的Lean Engine的话，绑定的域名需要备案。在`设置->域名绑定`界面填写想要绑定的域名，然后在域名提供商填写一条新的`CNAME`解析。等待验证通过后，再添加一条环境变量：`ADMIN_URL`，参数填域名。

之后在![管理域名配置](http://file.yocoh.cn/images/2020/07/19/image30b7d7056a2b3947.png)

这里填写邮箱，用户名和密码。

为了安全考虑，`email` 必须为配置中的 `SMTP_USER` 或 `TO_EMAIL`， 否则不允许登录

这样子就能用自己的域名访问管理评论啦。



##### **休眠**

`LeanCloud`免费版是会强制休眠的：

* 每天必须休眠 6 个小时
* 30 分钟内没有外部请求，则休眠。
* 休眠后如果有新的外部请求实例则马上启动（但激活时此次发送邮件会失败）

为了出现这种情况，我们使用定时器让其在7-23点之间每20分钟访问一次，这样就可以保持每天绝大多数时间是正常的。

![定时任务](http://file.yocoh.cn/images/2020/07/19/imagef65e9da9a1f02e52.png)

点击`云引擎->定时任务->创建定时任务`,名称可以随意填写，函数选择`self_wake`，`Cron`表达式写为`0 */20 7-23 * * ?`之后就可以在日志中看到提示了。

![日志提示](http://file.yocoh.cn/images/2020/07/19/image49fc641f8913848c.png)

最后，使用`resend-mails`函数，`Cron`写为`0 59 7 * * *`，表示每天早上检查漏发的通知邮件并补发。这样子的话就可以最大限度地保证不会出现漏发的情况了。当然，为了稳定最好还是升级至标准版。



#### **写在最后**

如果需要微信或QQ进行通知，请参阅：[antmoe的文章](https://www.cnblogs.com/antmoe/p/12904118.html)

如果需要阅读Valine官方文档，请参阅：[Valine](https://valine.js.org/)

如果需要阅读Valine-admin的文档，请参阅：[Valine-admin](https://github.com/zhaojun1998/Valine-Admin)

如果想要体验评论或者有其他问题，请随时在下方评论骚扰。



peace yo~